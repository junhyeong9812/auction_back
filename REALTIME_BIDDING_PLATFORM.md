# 실시간 입찰 플랫폼 (Realtime Bidding Platform)

## 1. 개요 (Overview)

본 프로젝트는 **WebSocket, Redis, Spring Scheduler**를 활용한 실시간 입찰 플랫폼의 백엔드 시스템입니다. 사용자가 물품에 실시간으로 입찰하고, 낙찰 후 채팅을 통해 거래를 완료하는 전체 프로세스를 지원합니다. 주요 기능으로는 실시간 입찰, 즉시구매, 자동 경매 종료, 실시간 알림, 1:1 채팅 등이 포함됩니다.

## 2. 시스템 아키텍처 (System Architecture)

![시스템 아키텍처](https://github.com/user-attachments/assets/3a99a780-6c69-41b3-8bf6-3aa22a95b015)

```
┌───────────────┐       ┌───────────────┐      ┌────────────────┐
│  클라이언트   │◀─────▶│  WebSocket    │◀────▶│   Redis Cache  │
│  (브라우저)   │       │  (STOMP/SJS)  │      │                │
└───────────────┘       └───────┬───────┘      └────────┬───────┘
                                │                       │
                                ▼                       ▼
                      ┌─────────────────────────────────────────┐
                      │              Spring Boot               │
                      │   ┌─────────────┐    ┌─────────────┐   │
                      │   │ 스케줄러    │    │ 이벤트리스너 │   │
                      │   └─────────────┘    └─────────────┘   │
                      └─────────────────────────────────────────┘
                                        │
                                        ▼
                      ┌─────────────────────────────────────────┐
                      │              Database                   │
                      │     (입찰 정보, 거래 내역, 채팅 등)      │
                      └─────────────────────────────────────────┘
```

### 핵심 컴포넌트

1. **WebSocket 서버**: STOMP 프로토콜을 사용하여 실시간 양방향 통신 제공
2. **Redis**: 경매 상태, 입찰 정보 등의 실시간 데이터 관리
3. **스케줄러**: 경매 시작/종료 자동화
4. **이벤트 리스너**: Redis 키 만료 감지하여 경매 종료 트리거
5. **데이터베이스**: 영구 데이터 저장 (입찰 내역, 채팅 메시지, 사용자 정보 등)

## 3. 주요 기능 (Key Features)

### 3.1 실시간 입찰 시스템
- **실시간 입찰**: WebSocket을 통한 즉각적인 입찰 처리 및 브로드캐스트
- **즉시구매**: 설정된 최대 가격으로 즉시 낙찰 처리
- **입찰 유효성 검증**: 포인트 잔액, 최소 입찰가, 경매 상태 자동 검증
- **동적 마감 시간**: 마감 직전 입찰 시 자동으로 경매 시간 연장

### 3.2 경매 생명주기 관리
- **자동 시작**: 예약된 시간에 경매 자동 시작
- **자동 종료**: Redis TTL 기반 경매 자동 종료 및 낙찰 처리
- **거래 완료 프로세스**: 판매자/구매자 양측 확인 후 포인트 정산

### 3.3 알림 및 채팅 시스템
- **실시간 알림**: 입찰, 낙찰, 채팅 메시지 등 다양한 이벤트 알림
- **1:1 채팅**: 낙찰 후 판매자-구매자 간 실시간 채팅 지원
- **메시지 읽음 상태**: 읽음/안읽음 상태 실시간 업데이트

## 4. 기술 스택 (Tech Stack)

### 백엔드
- **Spring Boot 3.x**: 애플리케이션 프레임워크
- **Spring WebSocket**: STOMP 프로토콜 지원
- **Spring Data JPA**: 데이터 접근 계층
- **Spring Data Redis**: 캐싱 및 실시간 데이터 관리
- **Spring Security + JWT**: 인증 및 권한 관리

### 데이터 저장소
- **MySQL**: 영구 데이터 저장
- **Redis**: 실시간 데이터 캐싱 및 메시징

### 기타
- **SockJS**: WebSocket 폴백 메커니즘
- **Docker**: 컨테이너화
- **Gradle**: 빌드 및 의존성 관리

## 5. 구현 상세 (Implementation Details)

### 5.1 실시간 입찰 시스템

#### WebSocket 컨트롤러 (AuctionStompController)
- STOMP 프로토콜 기반 WebSocket 메시지 처리 컨트롤러
- `/app/bid` 엔드포인트를 통해 입찰 요청 수신
- JWT 기반 사용자 인증 후 입찰 서비스 호출
- 입찰 결과를 `/topic/auction/{auctionId}` 채널로 브로드캐스트

#### 입찰 처리 서비스 (RealtimeAuctionServiceImpl)
- 입찰 요청의 유효성 검증 (경매 상태, 포인트 잔액, 최소 입찰가 등)
- 최고 입찰가/입찰자 정보 업데이트 및 Redis에 저장
- 즉시구매 기능 별도 처리 로직 구현
- 이전 입찰자 환불 처리 및 알림 전송
- 마감 임박 시 경매 시간 연장 처리

### 5.2 경매 스케줄링 및 자동화

#### 경매 스케줄러 (AuctionSchedulerService)
- `@Scheduled` 어노테이션을 사용한 주기적 작업 실행
- 30분 간격으로 예약된 경매 시작 처리
- 예약된 시간이 된 경매를 자동으로 `SCHEDULED` → `ONGOING` 상태로 변경
- 경매 시작 시 Redis에 초기 데이터 설정

#### Redis 키 만료 리스너 (AuctionExpirationListener)
- Redis의 `keyspace notifications` 기능을 활용한 키 만료 이벤트 감지
- `expired__:*` 채널을 구독하여 경매 키 만료 시 자동으로 이벤트 수신
- 만료된 경매의 ID를 추출하여 경매 종료 서비스 호출

#### 경매 종료 처리 서비스 (AuctionExpiredServiceImpl)
- Redis에서 최종 입찰 정보(최고가, 낙찰자) 추출
- 경매 상태를 `ONGOING` → `ENDED`로 업데이트
- 낙찰자와 판매자 간 채팅방 자동 생성
- 낙찰/유찰 결과에 따른 알림 전송
- 최종 입찰 정보 DB에 영구 저장

### 5.3 알림 및 채팅 시스템

#### 채팅 메시지 컨트롤러 (ChatController)
- 채팅방 구독 처리 (`/app/chat.subscribe/{roomId}`)
- 사용자별 메시지 전송 처리 (`/app/chat.send/{roomId}`)
- 메시지 전송 시 상대방에게 실시간 알림 발송
- 메시지 읽음 상태 업데이트 처리

#### 알림 서비스 (NotificationServiceImpl)
- 경매 입찰, 낙찰, 채팅 등 다양한 이벤트에 대한 알림 생성
- 알림 내용 DB 저장 및 실시간 WebSocket 전송
- 읽지 않은 알림 목록 조회 및 읽음 처리 기능
- 알림 타입별(BID, OUTBID, CHAT, SYSTEM 등) 차별화된 처리

## 6. 성능 최적화 (Performance Optimization)

### 6.1 Redis 활용

Redis를 활용하여 다음과 같은 성능 최적화를 구현했습니다:

1. **인메모리 데이터 처리**: 실시간 입찰 정보를 메모리에서 처리하여 응답 시간 최소화
2. **TTL 기반 경매 자동 만료**: 별도 스케줄러 없이 Redis의 키 만료 기능 활용
3. **입찰 정보 캐싱**: 자주 조회되는 최고가, 최고 입찰자 정보를 캐싱하여 DB 부하 감소

### 6.2 메시징 최적화

1. **선택적 브로드캐스트**: 필요한 클라이언트에게만 메시지 전송
2. **메시지 그룹화**: 유사한 알림은 주기적으로 배치 처리
3. **읽기 전용 캐시**: 자주 조회되는 정보는 읽기 전용 캐시로 관리

## 7. 확장성 고려사항 (Scalability Considerations)

### 7.1 수평적 확장

1. **WebSocket 서버 분산**: 클러스터 구성으로 동시 접속자 수 증가에 대응
2. **Redis 클러스터**: 캐시 데이터 분산 저장으로 성능 향상
3. **DB 샤딩**: 데이터 증가에 따른 데이터베이스 샤딩 전략 마련

### 7.2 서비스 분리

1. **마이크로서비스 아키텍처**: 경매, 채팅, 알림 등 핵심 기능을 별도 서비스로 분리 가능
2. **이벤트 기반 아키텍처**: 각 컴포넌트 간 낮은 결합도를 위한 이벤트 기반 통신 구현

## 8. 기술적 도전과 해결 방법 (Technical Challenges & Solutions)

### 8.1 동시성 제어

**도전**: 다수 사용자의 동시 입찰 처리 시 경쟁 상태(Race Condition) 발생 위험

**해결**:
- Redis의 원자적 연산(atomic operation) 활용
- 낙관적 락(Optimistic Lock) 구현으로 데이터 일관성 보장

### 8.2 WebSocket 연결 안정성

**도전**: 네트워크 불안정으로 인한 WebSocket 연결 끊김 처리

**해결**:
- SockJS를 활용한 폴백 메커니즘 구현
- 자동 재연결 및 메시지 큐 적용으로 메시지 손실 방지

### 8.3 분산 환경에서의 세션 관리

**도전**: 여러 서버 인스턴스 간 사용자 세션 동기화 문제

**해결**:
- Redis 기반 세션 스토리지 구현
- JWT 활용한 무상태(Stateless) 인증 메커니즘 적용

## 9. 결론

이 실시간 입찰 플랫폼은 WebSocket, Redis, Spring 기반 스케줄러를 활용하여 고성능, 고가용성의 실시간 경매 시스템을 구현했습니다. 실시간 입찰, 채팅, 알림 기능을 통합하여 사용자 경험을 극대화하였으며, 확장성과 성능을 고려한 아키텍처 설계로 대규모 트래픽에도 안정적으로 동작할 수 있는 시스템을 구축했습니다.